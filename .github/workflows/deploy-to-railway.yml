name: CI & Deploy to Railway

on:
  push:
    branches: [ main ]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install pip deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests (if any)
        run: |
          if [ -f pytest.ini ] || [ -d tests ]; then
            pytest -q || true
          else
            echo "No tests detected; skipping."
          fi

      - name: Build Docker image (artifact)
        run: |
          docker build -t superagi:${{ github.sha }} .

      - name: Deploy to Railway (optional)
        if: secrets.RAILWAY_API_TOKEN != ''
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
          RAILWAY_SERVICE_NAME: ${{ secrets.RAILWAY_SERVICE_NAME }}
        run: |
          # Install Railway CLI
          npm ci -g @railway/cli || npm i -g @railway/cli
          # Login using API token
          railway login --apiKey "$RAILWAY_API_TOKEN"
          # Attempt a non-interactive deploy. If you prefer to use Railway's GitHub integration,
          # leave RAILWAY_API_TOKEN empty and Railway will deploy automatically on push.
          if [ -n "$RAILWAY_SERVICE_NAME" ]; then
            echo "Deploying to Railway service: $RAILWAY_SERVICE_NAME"
            # 'railway up' will attempt to deploy; adjust flags as needed for your project
            railway up --service "$RAILWAY_SERVICE_NAME" --detach || railway deploy
          else
            echo "No RAILWAY_SERVICE_NAME provided; running 'railway up' to deploy to default project"
            railway up --detach || true
          fi

      - name: Deployment skipped
        if: secrets.RAILWAY_API_TOKEN == ''
        run: |
          echo "RAILWAY_API_TOKEN not set. To enable CI-driven deploys, add RAILWAY_API_TOKEN and RAILWAY_SERVICE_NAME to repo secrets."
